{% extends "evaluation/base.html" %}
{% load form_tags %}
{% load static %}

{% block title %}
  Evaluate {{ employee.user.get_full_name }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'evaluation/css/form_detail.css' %}">
<link rel="stylesheet" href="{% static 'evaluation/css/evaluation.css' %}">
{% endblock %}

{% block content %}
<div class="fh-wrap">
  <div class="fh-sheet">
    <div class="fh-head">
      <div>
        <h2 class="fh-title">{{ evaluation.form.name }} - {{ evaluation.department.title }}</h2>
        <div class="fh-sub">
          <strong>Evaluating:</strong> {{ employee.user.get_full_name }}<br>
          <strong>Week:</strong> {{ week_start }} to {{ week_end }}<br>
          <strong>Department:</strong> {{ evaluation.department.title }}<br>
          <strong>Form:</strong> {{ evaluation.form.name }}
        </div>
      </div>
    </div>

    <div class="fh-body">
      {# Banner if cannot submit #}
      {% if not can_submit %}
        <div class="fh-row">
          <div class="flash-message flash-warning">
            <i class="fas fa-exclamation-triangle flash-icon"></i>
            <div class="flash-content">
              {% if evaluation.submitted_at %}
                You've already submitted this on {{ evaluation.submitted_at|date:"M j, Y, P" }}.
              {% else %}
                This evaluation is from a previous week and cannot be edited.
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}

      <form method="post" id="evaluation-form" {% if not can_submit %}disabled{% endif %}>
        {% csrf_token %}

        {# Non-field errors #}
        {% if form.non_field_errors %}
          <div class="fh-row">
            <div class="flash-message flash-error">
              <i class="fas fa-exclamation-circle flash-icon"></i>
              <div class="flash-content">
                {% for err in form.non_field_errors %}
                  <p>{{ err }}</p>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}

        {# Fields #}
        {% for field in form %}
          {% if field.name|slice:":8" == "section_" %}
            <div class="fh-row">
              <h3 class="section-header">
                {{ field.value|default:field.initial|default:field.label|title }}
              </h3>
            </div>
          {% else %}
            <div class="fh-row{% if forloop.counter0 == 0 %} first-question{% endif %}">
              <label for="{{ field.id_for_label }}" class="fh-label">
                {{ field.label }}{% if field.field.required %}<span style="color:#ef4444;">*</span>{% endif %}
              </label>

              {% if field.help_text %}
                <div class="fh-help">{{ field.help_text }}</div>
              {% endif %}

              {# Render field itself #}
              {{ field }}

              {# Error once, DRY #}
              {% if field.errors %}
                <div class="field-error-message">{{ field.errors.0 }}</div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        {# Error summary #}
        {% if form.errors %}
          <div class="fh-row">
            <div class="flash-message flash-error">
              <i class="fas fa-exclamation-circle flash-icon"></i>
              <div class="flash-content">
                <strong>Please fix the errors below:</strong>
                <ul style="margin-top:0.5rem; padding-left:1rem;">
                  {% for field in form %}
                    {% for err in field.errors %}
                      <li><strong>{{ field.label }}:</strong> {{ err }}</li>
                    {% endfor %}
                  {% endfor %}
                  {% for err in form.non_field_errors %}
                    <li>{{ err }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endif %}
      </form>
    </div>

    <div class="fh-foot">
      <a href="{% url 'evaluation:dashboard2' %}" class="btn btn-secondary">Cancel</a>
      {% if can_submit %}
        <button type="submit" form="evaluation-form" class="btn btn-accent">
          {% if evaluation.status == "completed" %}Update Evaluation{% else %}Submit Evaluation{% endif %}
        </button>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'evaluation/js/dynamic_evaluation.js' %}"></script>
{% endblock %}
