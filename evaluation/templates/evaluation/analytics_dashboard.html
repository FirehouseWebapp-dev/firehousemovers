{% extends "base.html" %}
{% load static %}

{% block title %}{{ department.title }} Analytics Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 20px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    
    .dashboard-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filters-section {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: #495057;
        margin: 0;
    }
    
    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        font-size: 14px;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 2rem;
        font-weight: bold;
        margin: 0;
        color: #007bff;
    }
    
    .stat-card p {
        margin: 5px 0 0 0;
        color: #6c757d;
        font-size: 14px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #495057;
        text-align: center;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #dee2e6;
    }
    
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filters-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">
                {{ department.title }} Analytics Dashboard
                {% if employee %}
                    - {{ employee.user.get_full_name|default:employee.user.username }}
                {% endif %}
            </h1>
            <div class="text-muted">
                <small>Last updated: {{ "now"|date:"M d, Y H:i" }}</small>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-group">
                <label for="range-filter">Time Range:</label>
                <select id="range-filter" onchange="updateDashboard()">
                    <option value="weekly" {% if range_type == 'weekly' %}selected{% endif %}>Week</option>
                    <option value="monthly" {% if range_type == 'monthly' %}selected{% endif %}>Month</option>
                    <option value="yearly" {% if range_type == 'yearly' %}selected{% endif %}>Year</option>
                </select>
            </div>
            
            {% if department_employees %}
            <div class="filter-group">
                <label for="employee-filter">Employee:</label>
                <select id="employee-filter" onchange="updateDashboard()">
                    <option value="">All Employees</option>
                    {% for emp in department_employees %}
                    <option value="{{ emp.id }}" {% if employee and employee.id == emp.id %}selected{% endif %}>
                        {{ emp.user.get_full_name|default:emp.user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="filter-group">
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3>{{ total_evaluations }}</h3>
            <p>Total Evaluations</p>
        </div>
        <div class="stat-card">
            <h3>{{ completion_rate }}%</h3>
            <p>Completion Rate</p>
        </div>
        <div class="stat-card">
            <h3>{{ start_date|date:"M d" }} - {{ end_date|date:"M d" }}</h3>
            <p>Date Range</p>
        </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Q1 Chart - Performance/Quantity (Line Chart) -->
        <div class="chart-container">
            <div class="chart-title">{{ question_labels.Q1 }}</div>
            <div class="chart-wrapper">
                <canvas id="chart-q1"></canvas>
            </div>
        </div>
        
        <!-- Q2 Chart - Accuracy (Bar Chart) -->
        <div class="chart-container">
            <div class="chart-title">{{ question_labels.Q2 }}</div>
            <div class="chart-wrapper">
                <canvas id="chart-q2"></canvas>
            </div>
        </div>
        
        <!-- Q3 Chart - Satisfaction (Pie Chart) -->
        <div class="chart-container">
            <div class="chart-title">{{ question_labels.Q3 }}</div>
            <div class="chart-wrapper">
                <canvas id="chart-q3"></canvas>
            </div>
        </div>
        
        <!-- Q4 Chart - Targets (Radar Chart) -->
        <div class="chart-container">
            <div class="chart-title">{{ question_labels.Q4 }}</div>
            <div class="chart-wrapper">
                <canvas id="chart-q4"></canvas>
            </div>
        </div>
        
        <!-- Q5 Chart - Confidence (Gauge Chart) -->
        <div class="chart-container">
            <div class="chart-title">{{ question_labels.Q5 }}</div>
            <div class="chart-wrapper">
                <canvas id="chart-q5"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Gauge Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-gauge@0.3.0/dist/chartjs-gauge.min.js"></script>

<script>
// Dashboard data from Django context
const dashboardData = {
    chartData: {{ chart_data|safe }},
    questionLabels: {{ question_labels|safe }},
    rangeType: "{{ range_type }}",
    startDate: "{{ start_date|date:'Y-m-d' }}",
    endDate: "{{ end_date|date:'Y-m-d' }}",
    granularity: "{{ granularity }}"
};

// Chart instances
let charts = {};

// Initialize all charts
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Q1 - Line Chart (Performance/Quantity)
    initializeLineChart('chart-q1', 'Q1');
    
    // Q2 - Bar Chart (Accuracy)
    initializeBarChart('chart-q2', 'Q2');
    
    // Q3 - Pie Chart (Satisfaction)
    initializePieChart('chart-q3', 'Q3');
    
    // Q4 - Radar Chart (Targets)
    initializeRadarChart('chart-q4', 'Q4');
    
    // Q5 - Gauge Chart (Confidence)
    initializeGaugeChart('chart-q5', 'Q5');
}

function initializeLineChart(canvasId, questionKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = dashboardData.chartData[questionKey];
    
    if (!data || !data.data || data.data.length === 0) {
        showNoDataMessage(canvasId);
        return;
    }
    
    const labels = data.data.map(item => item.period);
    const values = data.data.map(item => item.value);
    
    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: data.label,
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeBarChart(canvasId, questionKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = dashboardData.chartData[questionKey];
    
    if (!data || !data.data || data.data.length === 0) {
        showNoDataMessage(canvasId);
        return;
    }
    
    const labels = data.data.map(item => item.period);
    const values = data.data.map(item => item.value);
    
    charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: data.label,
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializePieChart(canvasId, questionKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = dashboardData.chartData[questionKey];
    
    if (!data || !data.data) {
        showNoDataMessage(canvasId);
        return;
    }
    
    const emojiData = data.data;
    const labels = Object.keys(emojiData);
    const values = Object.values(emojiData);
    
    if (values.every(v => v === 0)) {
        showNoDataMessage(canvasId);
        return;
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: [
                    '#dc3545', // Red for 😞
                    '#ffc107', // Yellow for 😐
                    '#28a745'  // Green for 😃
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeRadarChart(canvasId, questionKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = dashboardData.chartData[questionKey];
    
    if (!data || !data.data || data.data.length === 0) {
        showNoDataMessage(canvasId);
        return;
    }
    
    const labels = data.data.map(item => item.period);
    const values = data.data.map(item => item.value);
    
    charts[canvasId] = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: data.label,
                data: values,
                borderColor: '#6f42c1',
                backgroundColor: 'rgba(111, 66, 193, 0.2)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5
                }
            }
        }
    });
}

function initializeGaugeChart(canvasId, questionKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = dashboardData.chartData[questionKey];
    
    if (!data || !data.data || data.data.length === 0) {
        showNoDataMessage(canvasId);
        return;
    }
    
    // Calculate average value for gauge
    const values = data.data.map(item => item.value);
    const averageValue = values.reduce((sum, val) => sum + val, 0) / values.length;
    
    charts[canvasId] = new Chart(ctx, {
        type: 'gauge',
        data: {
            labels: [data.label],
            datasets: [{
                data: [averageValue],
                backgroundColor: ['#007bff'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            valueLabel: {
                display: true,
                fontSize: 20,
                color: '#000'
            },
            needle: {
                display: true,
                color: '#000'
            }
        }
    });
}

function showNoDataMessage(canvasId) {
    const canvas = document.getElementById(canvasId);
    const container = canvas.parentElement;
    container.innerHTML = '<div class="no-data">No data available</div>';
}

function updateDashboard() {
    const range = document.getElementById('range-filter').value;
    const employee = document.getElementById('employee-filter') ? document.getElementById('employee-filter').value : '';
    
    let url = window.location.pathname;
    if (employee) {
        url = url.replace(/\/\d+\/$/, `/${employee}/`);
    }
    url += `?range=${range}`;
    
    window.location.href = url;
}

function refreshDashboard() {
    window.location.reload();
}

// Update charts when window is resized
window.addEventListener('resize', function() {
    Object.values(charts).forEach(chart => {
        if (chart) chart.resize();
    });
});
</script>
{% endblock %}
