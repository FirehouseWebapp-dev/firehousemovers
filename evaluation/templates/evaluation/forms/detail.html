{% extends "evaluation/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'evaluation/css/form_detail.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4">
  {% csrf_token %}

  <!-- Flash Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="flash-message flash-{{ message.tags }}">
        <div class="flash-icon">
          {% if message.tags == 'error' %}
            <i class="fa-solid fa-exclamation-triangle"></i>
          {% elif message.tags == 'success' %}
            <i class="fa-solid fa-check-circle"></i>
          {% else %}
            <i class="fa-solid fa-info-circle"></i>
          {% endif %}
        </div>
        <div class="flash-content">
          {{ message }}
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Header -->
  <div class="flex items-start justify-between mb-6">
    <div>
      <div class="text-3xl font-extrabold text-red-500">{{ form_obj.name }}</div>
      <div class="text-lg text-gray-300">{{ form_obj.department.title }}</div>

      <div class="mt-3 flex items-center gap-2">
        {% if form_obj.is_active %}
          <span class="pill"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>Active</span>
        {% else %}
          <span class="pill"><span class="w-2 h-2 rounded-full bg-gray-400 inline-block"></span>Inactive</span>
        {% endif %}
        <span class="pill"><i class="fa-regular fa-note-sticky"></i> {{ questions|length }} questions</span>
      </div>
    </div>

    <div class="toolbar flex items-center gap-3">
      <a href="{% url 'evaluation:evalform_preview' form_obj.id %}" class="btn">
        <i class="fa-regular fa-eye mr-2"></i> Preview
      </a>
      <form method="post" action="{% url 'evaluation:evalform_activate' form_obj.id %}">
        {% csrf_token %}
        <button class="btn btn-accent" {% if questions|length == 0 and not form_obj.is_active %}disabled title="Cannot activate: No questions added yet"{% endif %}>
          {% if form_obj.is_active %}
            <i class="fa-solid fa-power-off mr-2"></i>Deactivate
          {% else %}
            <i class="fa-solid fa-bolt mr-2"></i>Make Active
          {% endif %}
        </button>
      </form>
    </div>
  </div>

  <!-- Quick tip -->
  <div class="sheet p-4 mb-6">
    <div class="text-sm text-gray-300">
      <i class="fa-solid fa-lightbulb text-yellow-400 mr-2"></i>
      Drag the grip (<i class="fa-solid fa-grip-vertical text-gray-400"></i>) to reorder (visual only). Click <b>Edit</b> to change wording, type, or help text.
    </div>
  </div>

  <!-- Questions list -->
  <div id="q-list" class="space-y-3">
    {% for q in questions %}
      <div class="q-item">
        <div class="drag"><i class="fa-solid fa-grip-vertical"></i></div>

        <div class="text-xl text-gray-300 w-7 text-center">
          {% if q.qtype == 'rating_5' %}<i class="fa-regular fa-star"></i>
          {% elif q.qtype == 'rating_10' %}<i class="fa-regular fa-star-half-stroke"></i>
          {% elif q.qtype == 'emoji_5' %}<i class="fa-regular fa-face-smile"></i>
          {% elif q.qtype == 'long_text' %}<i class="fa-regular fa-comment-dots"></i>
          {% elif q.qtype == 'number' %}<i class="fa-solid fa-hashtag"></i>
          {% else %}<i class="fa-regular fa-square"></i>
          {% endif %}
        </div>

        <div class="flex-1">
          <div class="q-title">{{ q.text|capfirst }}</div>
          <div class="q-sub">
            {{ q.get_qtype_display }}
            {% if q.help_text %} Â· {{ q.help_text }}{% endif %}
          </div>
        </div>

        <div class="q-actions flex items-center gap-4">
          <a href="{% url 'evaluation:question_edit' q.id %}" class="text-gray-300 hover:text-white" title="Edit Question">
            <i class="fa-solid fa-pen-to-square"></i>
            <span class="sr-only">Edit Question</span>
          </a>
          {% if q.qtype == "select" %}
            <a href="{% url 'evaluation:choice_add' q.id %}" class="text-gray-300 hover:text-white">
              <i class="fa-regular fa-square-plus mr-1"></i> Choice
            </a>
          {% endif %}
          <span class="delete-btn" onclick="openDeleteModal({{ q.id }}, '{{ q.text|escapejs }}')">
            <i class="fa-solid fa-trash"></i>
          </span>
        </div>
      </div>
    {% empty %}
      <div class="sheet p-6 text-gray-300">No questions yet. Click <b>+ Add Question</b> to get started.</div>
    {% endfor %}
  </div>

  <!-- Floating Add -->
  <a href="{% url 'evaluation:question_add' form_obj.id %}" class="floating-add">
    <i class="fa-solid fa-plus"></i> Add Question
  </a>

  <!-- Delete Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Delete Question</h3>
        <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this question?</p>
        <p><strong id="questionText"></strong></p>
        <p class="text-red-400 text-sm mt-2">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn-modal btn-delete" onclick="deleteQuestion()">Delete</button>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'evaluation/js/drag_drop.js' %}"></script>
<script src="{% static 'evaluation/js/modal.js' %}"></script>
{% endblock %}
