{% extends "evaluation/base.html" %}
{% load static %}

{% block title %}Performance Overview - Senior Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'evaluation/css/analytics-dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- Header -->
<div class="analytics-header bg-[#1a1a1a] border-b border-gray-700 p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-3xl font-bold text-red-500 mb-2">Performance Overview</h1>
            <p class="text-gray-400">Department metrics and manager performance trends</p>
            {% if start_date or end_date %}
            <div class="mt-2 inline-flex items-center bg-blue-900/30 border border-blue-600/50 rounded px-3 py-1.5 text-sm">
                <i class="fas fa-filter text-blue-400 mr-2"></i>
                <span class="text-blue-300 font-medium">
                    Filtered: 
                    {% if start_date %}{{ start_date }}{% endif %}
                    {% if start_date and end_date %} to {% endif %}
                    {% if end_date %}{{ end_date }}{% endif %}
                </span>
            </div>
            {% endif %}
        </div>
        <div class="flex items-center space-x-4">
            <div class="text-right">
                <p class="text-sm text-gray-400">Last Viewed</p>
                <p class="text-sm text-white" id="last-viewed-time">{{ last_viewed_at|date:"M d, Y H:i" }}</p>
            </div>
            <button id="refreshButton" class="analytics-refresh-btn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <!-- Date Filters -->
    <div class="flex items-center space-x-4">
        <form method="GET" action="" class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <label for="start_date" class="text-sm text-gray-400">Start Date:</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date|default:'' }}" 
                       class="bg-[#262626] text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end_date" class="text-sm text-gray-400">End Date:</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date|default:'' }}" 
                       class="bg-[#262626] text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500">
            </div>
            <input type="hidden" name="period" value="{{ period_type }}">
            <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition-colors">
                <i class="fas fa-filter mr-1"></i> Apply
            </button>
            <a href="?period={{ period_type }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm transition-colors">
                <i class="fas fa-times mr-1"></i> Clear
            </a>
        </form>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="analytics-content">
    <!-- Department Performance Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {% for metric in department_metrics %}
        <div class="analytics-card">
            <div class="analytics-card-header">
                <div class="analytics-card-icon {% cycle 'bg-blue-600' 'bg-green-600' 'bg-purple-600' 'bg-orange-600' 'bg-indigo-600' 'bg-pink-600' %}">
                    {% if 'sales' in metric.department.title|lower %}
                        <i class="fas fa-chart-line"></i>
                    {% elif 'driver' in metric.department.title|lower or 'field' in metric.department.title|lower or 'mover' in metric.department.title|lower %}
                        <i class="fas fa-truck"></i>
                    {% elif 'warehouse' in metric.department.title|lower %}
                        <i class="fas fa-warehouse"></i>
                    {% else %}
                        <i class="fas fa-users"></i>
                    {% endif %}
                </div>
                <div class="analytics-card-title">
                    <h3>{{ metric.department.title }}</h3>
                    <p class="text-gray-400">{{ metric.metric_label }}</p>
                </div>
            </div>
            <div class="analytics-card-content">
                <div class="analytics-stat-large">{{ metric.metric_value }}</div>
                <div class="analytics-stat-breakdown">
                    <span class="text-blue-400">{{ metric.employee_count }} Employees</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="analytics-card col-span-3">
            <div class="analytics-card-content text-center py-8">
                <p class="text-gray-400">No department data available</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Q1: Work Volume Comparison -->
    {% if dept_q1_work_volume.has_data %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Work Volume Across Departments
                    </h2>
                    
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Average Work Volume by Department</h3>
                <div class="analytics-chart-type-badge">Bar Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 400px; padding: 20px;">
                <canvas id="dept-q1-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Q2: Quality/Timeliness Comparison -->
    {% if dept_q2_quality.has_data %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-percent mr-2"></i>
                        Quality & Timeliness Across Departments
                    </h2>
                    
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Performance Accuracy/Completion Rates</h3>
                <div class="analytics-chart-type-badge">Bar Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 400px; padding: 20px;">
                <canvas id="dept-q2-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Q3: 5-Star Rating Comparison -->
    {% if dept_q3_rating.has_data %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-star mr-2"></i>
                        Professional Competence Across Departments
                    </h2>
                    
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Average Expertise Rating by Department</h3>
                <div class="analytics-chart-type-badge">Line Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 400px; padding: 20px;">
                <canvas id="dept-q3-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Q4: Emoji Satisfaction Comparison -->
    {% if dept_q4_satisfaction.has_data %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-smile mr-2"></i>
                        Customer/User Satisfaction Across Departments
                    </h2>
                    
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Employee Impact on Satisfaction</h3>
                <div class="analytics-chart-type-badge">Pie Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 500px; padding: 20px;">
                <canvas id="dept-q4-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Q5: Confidence Rating Comparison -->
    {% if dept_q5_confidence.has_data %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-chart-line mr-2"></i>
                        Employee Confidence Across Departments
                    </h2>
                    
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Long-term Trust in Employee Ability</h3>
                <div class="analytics-chart-type-badge">Bar Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 400px; padding: 20px;">
                <canvas id="dept-q5-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Managers Rating Trends Section -->
    {% if managers_rating_trends.labels %}
    <div class="analytics-section mb-8">
        <div class="analytics-section-header">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="analytics-section-title">
                        <i class="fas fa-users-cog mr-2"></i>
                        All Managers Rating Trends
                    </h2>
                    <div class="analytics-section-subtitle">
                        {{ period_type|title }} performance comparison across all managers
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="filter-btn {% if period_type == 'monthly' %}active{% endif %}" data-period="monthly">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        Monthly
                    </button>
                    <button class="filter-btn {% if period_type == 'quarterly' %}active{% endif %}" data-period="quarterly">
                        <i class="fas fa-calendar-week mr-1"></i>
                        Quarterly
                    </button>
                    <button class="filter-btn {% if period_type == 'annually' %}active{% endif %}" data-period="annually">
                        <i class="fas fa-calendar mr-1"></i>
                        Annually
                    </button>
                </div>
            </div>
        </div>

        <div class="analytics-chart-card">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">Manager Overall Ratings Over Time</h3>
                <div class="analytics-chart-type-badge">Line Chart</div>
            </div>
            <div class="analytics-chart-container" style="height: 400px;">
                <canvas id="managers-rating-trends-chart" class="analytics-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% load static %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Set up performance data for the dashboard
window.managersRatingTrends = {{ managers_rating_trends_json|safe }};
window.deptQ1WorkVolume = {{ dept_q1_work_volume_json|safe }};
window.deptQ2Quality = {{ dept_q2_quality_json|safe }};
window.deptQ3Rating = {{ dept_q3_rating_json|safe }};
window.deptQ4Satisfaction = {{ dept_q4_satisfaction_json|safe }};
window.deptQ5Confidence = {{ dept_q5_confidence_json|safe }};

console.log('Managers Rating Trends Data:', window.managersRatingTrends);
console.log('Q1 Work Volume Data:', window.deptQ1WorkVolume);
console.log('Q2 Quality Data:', window.deptQ2Quality);
console.log('Q3 Rating Data:', window.deptQ3Rating);
console.log('Q4 Satisfaction Data:', window.deptQ4Satisfaction);
console.log('Q5 Confidence Data:', window.deptQ5Confidence);
</script>
<script src="{% static 'evaluation/js/senior_performance_overview.js' %}"></script>
{% endblock %}

